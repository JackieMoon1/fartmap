<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FartMap â€” Online</title>
  <meta name="theme-color" content="#0f1221" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icons/pwa-192.png" />
  <link rel="apple-touch-icon" href="./icons/pwa-192.png" />
  <style>
    :root{ --bg:#0f1221; --card:#171a2e; --muted:#8b93b8; --text:#e8ecff; --accent:#8ef0a7; --accent2:#dba9ff; --good:#a6ff9e; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background: radial-gradient(1200px 600px at 10% 0%, #141836, #0b0d1a 60%), var(--bg); color:var(--text); display:flex; flex-direction:column; }
    header{ padding:24px; display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .brand{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.3px}
    .logo{width:40px; height:40px; border-radius:10px; background: conic-gradient(from 210deg, var(--accent), var(--accent2)); box-shadow: var(--shadow)}
    .subtitle{color:var(--muted); font-weight:600; font-size:12px}
    main{width:min(1100px, 92vw); margin:0 auto 36px; display:grid; gap:18px}
    .grid{display:grid; grid-template-columns:repeat(12, 1fr); gap:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card .body{padding:18px}
    .card h2{margin:4px 0 6px; font-size:18px}
    .muted{color:var(--muted)}
    .controls{display:flex; gap:12px; flex-wrap:wrap}
    button{ appearance:none; border:0; cursor:pointer; font-weight:700; letter-spacing:.2px; padding:14px 16px; border-radius:14px; background:#202545; color:var(--text); box-shadow:var(--shadow); transition: transform .06s ease, background .2s ease, opacity .2s ease; }
    button:hover{transform:translateY(-1px)} button:active{transform:translateY(0)}
    .btn-big{background: linear-gradient(180deg, #2a2f60, #282d58)}
    .btn-little{background: linear-gradient(180deg, #1f3d36, #19392f)}
    .btn-clear{background: transparent; border:1px dashed rgba(255,255,255,.25); color:#c7ccef}
    .pill{padding:10px 12px; border-radius:999px; background:#10142d; border:1px solid rgba(255,255,255,.06); font-weight:700}
    .pill.good{background:#10301f; color:var(--good); border-color:rgba(166,255,158,.25)}
    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    th{font-size:12px; text-transform:uppercase; letter-spacing:.14em; color:var(--muted); text-align:left}
    td, th{padding:10px 12px}
    tbody tr{background:#111430; border-radius:10px; outline:1px solid rgba(255,255,255,.06)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .right{margin-left:auto}
    .hidden{display:none}
    .modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.5)}
    .modal>.dialog{background:#0f1221; border:1px solid rgba(255,255,255,.1); border-radius:14px; padding:18px; width:min(520px,92vw)}
    input{background:#0e1130; color:#e8ecff; border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:10px 12px; font-size:16px}
    .hint{color:#8b93b8; font-size:12px; margin-top:6px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div style="font-size:20px; line-height:1.05">FartMap</div>
        <div class="subtitle">Track your toots. Get the stats you never asked for.</div>
      </div>
    </div>
    <div class="controls" role="group" aria-label="Add a fart">
      <button id="btnLittle" class="btn-little" title="Record a little fart (L)">ğŸ’¨ Little</button>
      <button id="btnBig" class="btn-big" title="Record a big fart (B)">ğŸŒªï¸ Big</button>
      <button id="btnUndo" class="btn-clear" title="Undo last entry (Ctrl+Z)">â†©ï¸ Undo</button>
      <button id="btnExport" class="btn-clear">ğŸ“¦ Export</button>
      <button id="btnImport" class="btn-clear">ğŸ“¥ Import</button>
      <input type="file" id="importFile" accept="application/json" hidden />
    </div>
  </header>

  <main>
    <section class="grid">
      <div class="card" style="grid-column: span 12;">
        <div class="body">
          <div class="row">
            <div class="pill" id="todayDate">Today</div>
            <div class="pill" id="streak">Streak: 0</div>
            <div class="pill" id="ytd">YTD: 0</div>
            <div class="right pill" id="me">Not signed in</div>
            <button id="btnLogin" class="btn-clear right">ğŸ”‘ Sign in</button>
          </div>
          <div style="height:12px"></div>
          <div class="row">
            <div class="pill">Today total: <strong id="todayTotal">0</strong></div>
            <div class="pill">Little: <strong id="todayLittle">0</strong></div>
            <div class="pill">Big: <strong id="todayBig">0</strong></div>
            <div class="pill">Allâ€‘time: <strong id="allTime">0</strong></div>
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: span 12;">
        <div class="body">
          <div class="row">
            <h2 style="margin:0">Leaderboard (today)</h2>
            <button id="btnRefreshLb" class="btn-clear right">ğŸ”„ Refresh</button>
          </div>
          <div class="muted" style="margin-bottom:10px">Public board â€” totals for today only</div>
          <table>
            <thead>
              <tr><th>#</th><th>User</th><th>Total</th><th>Little</th><th>Big</th></tr>
            </thead>
            <tbody id="lbBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="grid-column: span 12;">
        <div class="body foot">Hotkeys: L little, B big, Ctrl+Z undo Â· Data stored locally + synced online when signed in.</div>
      </div>
    </section>
  </main>

  <!-- Username modal -->
  <div class="modal hidden" id="usernameModal" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3 style="margin:0 0 8px">Pick a username</h3>
      <div class="hint">3â€“20 letters/numbers/underscore. This will be public.</div>
      <div style="height:10px"></div>
      <div class="row">
        <input id="usernameInput" placeholder="your_name" maxlength="20" />
        <button id="usernameSave">Save</button>
        <button id="usernameCancel" class="btn-clear">Cancel</button>
      </div>
      <div class="hint" id="usernameMsg"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ===== CONFIG: fill these in =====
    const SUPABASE_URL = 'https://rlafhblrnlrnwadmhvuq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsYWZoYmxybmxybndhZG1odnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4ODQ1MzksImV4cCI6MjA3MDQ2MDUzOX0.eRIzeWKJXAhW6g4ZJ2_rvqiIdsrFt9C96oKatevtWTc';

    // ===== Local storage keys =====
    const STORAGE_KEY = 'fartmap_events_v1';
    const META_KEY = 'fartmap_meta_v1';
    const LAST_SYNC_KEY = 'fartmap_last_sync_ts';

    // ===== Supabase client =====
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    // ===== Utilities =====
    const qs = (sel)=> document.querySelector(sel);
    function loadEvents(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); } catch { return []; } }
    function saveEvents(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
    function loadMeta(){ try { return JSON.parse(localStorage.getItem(META_KEY)||'{}'); } catch { return {}; } }
    function saveMeta(m){ localStorage.setItem(META_KEY, JSON.stringify(m)); }
    function fmtDate(d){ return d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'}); }
    function isSameLocalDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
    function startOfLocalDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

    // ===== Auth + username =====
    async function ensureSignedIn(){
      const { data: { session } } = await supabase.auth.getSession();
      if (session) return session.user;
      const { data, error } = await supabase.auth.signInAnonymously();
      if (error) { alert('Sign-in error: '+ error.message); throw error; }
      return data.user;
    }

    async function getMyProfile(){
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return null;
      const { data } = await supabase.from('profiles').select('*').eq('id', session.user.id).maybeSingle();
      return data;
    }

    async function setUsername(username){
      const clean = username.trim();
      if (!/^\w{3,20}$/.test(clean)) throw new Error('Use 3â€“20 letters/numbers/underscore');
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) throw new Error('Not signed in');
      const row = { id: session.user.id, username: clean };
      const { error } = await supabase.from('profiles').upsert(row, { onConflict: 'id' });
      if (error) throw error;
      return clean;
    }

    // ===== Sync: push local events added since last sync =====
    async function syncEvents(){
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;
      const uid = session.user.id;
      const lastSync = parseInt(localStorage.getItem(LAST_SYNC_KEY)||'0',10);
      const all = loadEvents();
      const toPush = all.filter(e => e.ts > lastSync);
      if (!toPush.length) return;
      const rows = toPush.map(e => ({ user_id: uid, kind: e.kind, ts: new Date(e.ts).toISOString() }));
      const { error } = await supabase.from('events').insert(rows);
      if (!error) localStorage.setItem(LAST_SYNC_KEY, String(Date.now()));
    }

    // ===== Leaderboard =====
    async function loadLeaderboard(){
      const { data, error } = await supabase.from('leaderboard_today').select('*').limit(100);
      if (error) { console.error(error); return; }
      const body = qs('#lbBody'); body.innerHTML = '';
      (data||[]).forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${r.username}</td><td><strong>${r.total}</strong></td><td>${r.little}</td><td>${r.big}</td>`;
        body.appendChild(tr);
      });
    }

    // ===== App logic (local counters from your original app) =====
    function render(){
      const events = loadEvents();
      const now = new Date();
      const todayEvents = events.filter(e => isSameLocalDay(new Date(e.ts), now));
      const tLittle = todayEvents.filter(e=>e.kind==='little').length;
      const tBig = todayEvents.filter(e=>e.kind==='big').length;
      qs('#todayDate').textContent = `Today Â· ${fmtDate(now)}`;
      qs('#todayLittle').textContent = tLittle;
      qs('#todayBig').textContent = tBig;
      qs('#todayTotal').textContent = todayEvents.length;
      qs('#allTime').textContent = events.length;
      const meta = loadMeta();
      qs('#streak').textContent = `Streak: ${meta.streak||0}`;
    }

    function record(kind){
      const now = new Date();
      const events = loadEvents();
      events.push({ ts: now.getTime(), kind });
      saveEvents(events);
      updateStreak(now);
      render();
      syncEvents().catch(console.error);
    }

    function updateStreak(now){
      const meta = loadMeta();
      const last = meta.lastActiveDay ? new Date(meta.lastActiveDay) : null;
      const todayStart = startOfLocalDay(now).getTime();
      if (!last) meta.streak = 1; else {
        const lastStart = startOfLocalDay(last).getTime();
        const diff = Math.round((todayStart - lastStart)/86400000);
        if (diff===1) meta.streak=(meta.streak||0)+1; else if (diff>1) meta.streak=1;
      }
      meta.lastActiveDay = todayStart; saveMeta(meta);
    }

    // ===== Wire up UI =====
    qs('#btnLittle').addEventListener('click', ()=>record('little'));
    qs('#btnBig').addEventListener('click', ()=>record('big'));
    qs('#btnUndo').addEventListener('click', ()=>{ const e=loadEvents(); e.pop(); saveEvents(e); render(); });
    qs('#btnExport').addEventListener('click', ()=>{ const payload = { events: loadEvents(), meta: loadMeta(), exportedAt: new Date().toISOString() }; const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `fartmap-backup-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); });
    qs('#btnImport').addEventListener('click', ()=> qs('#importFile').click());
    qs('#importFile').addEventListener('change', (e)=>{ if (e.target.files && e.target.files[0]) { const reader = new FileReader(); reader.onload = ()=>{ try{ const parsed=JSON.parse(reader.result); if(!Array.isArray(parsed.events)) throw new Error('Invalid file'); localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed.events)); if(parsed.meta) localStorage.setItem(META_KEY, JSON.stringify(parsed.meta)); render(); alert('Import complete.'); } catch(err){ alert('Import failed: '+err.message); } }; reader.readAsText(e.target.files[0]); } });

    // Login + username flow
    qs('#btnLogin').addEventListener('click', async ()=>{
      const user = await ensureSignedIn();
      const profile = await getMyProfile();
      if (profile?.username) { qs('#me').textContent = '@'+profile.username; await syncEvents(); await loadLeaderboard(); return; }
      // show username modal
      qs('#usernameModal').classList.remove('hidden');
      qs('#usernameMsg').textContent = '';
      qs('#usernameInput').value = '';
    });
    qs('#usernameCancel').addEventListener('click', ()=> qs('#usernameModal').classList.add('hidden'));
    qs('#usernameSave').addEventListener('click', async ()=>{
      const name = qs('#usernameInput').value;
      try {
        const clean = await setUsername(name);
        qs('#me').textContent = '@'+clean;
        qs('#usernameModal').classList.add('hidden');
        await syncEvents();
        await loadLeaderboard();
      } catch(err){ qs('#usernameMsg').textContent = err.message; }
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;
      if (e.key==='l' || e.key==='L') record('little');
      if (e.key==='b' || e.key==='B') record('big');
      if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ const evs=loadEvents(); evs.pop(); saveEvents(evs); render(); }
    });

    // Initial
    (async function init(){
      if ('serviceWorker' in navigator) {
        try{ await navigator.serviceWorker.register('./sw.js'); }catch(e){}
      }
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        const profile = await getMyProfile();
        if (profile?.username) qs('#me').textContent = '@'+profile.username; else qs('#me').textContent = 'Pick a username';
        await syncEvents();
      }
      render();
      await loadLeaderboard();
      qs('#btnRefreshLb').addEventListener('click', loadLeaderboard);
    })();
  </script>
</body>
</html>

